# Workflow 说明文档

## 1. 项目名称
**Notion 评论同步与卡片处理自动化工作流** (Notion Comment Sync & Card Processing Workflow)

## 2. 触发条件
- **触发方式**: GitHub Actions 定时 cron + 手动触发
- **具体时间**: 每天凌晨 3:00 (Brisbane 时间，UTC 16:00)
- **频率**: 每日自动执行
- **手动触发**: 可在 GitHub Actions 页面手动运行

## 3. 主要逻辑
这个 Node.js 脚本主要做以下几件事：

### 3.1 评论同步处理
- 扫描 Reference 数据库中的笔记，查找未处理的评论
- 将评论内容转换为结构化的知识卡片
- 自动创建卡片到目标数据库
- 更新 Reference 笔记的"自动化"状态为"已执行"

### 3.2 卡片状态检查
- 检查目标数据库中所有有 DiscussionID 但"它在解决什么问题？"字段为空的卡片
- 识别需要人工处理的待办卡片

### 3.3 工作流管理
- **Reference 处理工作流**: 优先处理 Reference 数据库的未执行笔记
- **卡片处理工作流**: 在 Reference 任务完成后，处理待办卡片
- 创建 Action 数据库任务，设置任务属性和关系链接

### 3.4 邮件通知系统
- 发送任务提醒邮件（包含任务链接）
- 发送未完成任务警告邮件
- 使用 QQ 邮箱 SMTP 服务

## 4. 输出内容

### 4.1 邮件内容
**任务提醒邮件**:
- 邮件标题: `📋 卡片处理需求提醒-YYYYMMDDHHMM`
- 邮件正文: 
  - 待处理卡片数量
  - 新创建任务的链接
  - 任务详情和卡片列表

**警告邮件**:
- 邮件标题: `⚠️ 卡片处理任务未完成警告-YYYYMMDDHHMM`
- 邮件正文:
  - 未完成任务信息
  - 提醒完成现有任务

### 4.2 数据库输出
- **Action 数据库**: 新建"卡片处理需求"或"Reference处理需求"任务
- **目标数据库**: 生成的知识卡片
- **Summary 数据库**: 更新 Summary 页面内容

## 5. 状态追踪

### 5.1 完成状态定义
- **Reference 任务**: 状态为"完成"时，允许后续卡片处理
- **卡片处理任务**: 状态为"未开始"、"进行中"、"已完成"等
- **自动化状态**: Reference 笔记的"自动化"字段标记为"已执行"

### 5.2 用户确认机制
- 需要用户手动将 Action 数据库中的任务标记为"完成"
- 系统会检查任务状态，未完成任务会阻止新任务创建
- 发送警告邮件提醒用户完成现有任务

### 5.3 错误日志
- 完整的执行日志记录在 GitHub Actions 中
- 本地日志文件记录详细执行过程
- 错误处理和异常捕获机制

## 6. 理想使用方式

### 6.1 执行时间建议
**推荐时间**: 凌晨 3:00 (Brisbane 时间)
- **优势**: 
  - 避开工作时间，不影响日常操作
  - 确保数据在第二天开始前已同步
  - 符合知识管理的"日清日结"原则

### 6.2 提醒方式优化
**当前方式**: 邮件通知
**建议改进**:
- 早上 9:00 检查邮件，查看新任务
- 在 Notion 中处理 Action 数据库任务
- 完成卡片的问题关联和分类

### 6.3 工作流程建议
1. **早上 9:00-10:00**: 查看邮件，了解新任务
2. **上午工作时间**: 处理 Reference 笔记和知识卡片
3. **下午**: 将卡片与具体问题建立联系
4. **晚上**: 复盘和整理，标记任务完成状态

### 6.4 个性化调整建议
- 如需调整执行时间，可修改 GitHub Actions 的 cron 设置
- 可增加 Slack/Teams 通知作为邮件补充
- 可设置不同时间段的处理优先级

---

## 技术架构
- **后端**: Node.js + Notion API
- **部署**: GitHub Actions + Cron
- **通知**: QQ 邮箱 SMTP
- **数据库**: Notion 多数据库协同工作
- **监控**: GitHub Actions 执行日志 + 本地日志系统
