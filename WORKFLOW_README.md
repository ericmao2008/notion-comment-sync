# 卡片处理工作流说明

## 🎯 功能概述

新增的卡片处理工作流可以自动识别需要人工处理的卡片，并创建相应的行动任务和发送邮件提醒。

## 🔍 触发条件

工作流会在以下条件下触发：
1. ✅ 字段"DiscussionID"有值
2. ❌ 字段"它在解决什么问题？"是空缺的
3. 这些卡片表示：通过阅读Reference库生成的知识卡片，还没有和要解决的问题建立联系

## 🚀 工作流步骤

### 步骤1: 检查待处理卡片
- 查询目标数据库，找到符合条件的卡片
- 按创建时间排序，最新的在前面

### 步骤2: 创建行动库任务
- 在行动库中创建新任务
- 任务文件名格式：`卡片处理需求-YYYYMMDDHHMM`
- 任务内容包含所有待处理卡片的详细信息

### 步骤3: 发送邮件通知
- 发送提醒邮件给指定邮箱
- 邮件包含行动库任务链接
- 邮件正文列出所有待处理卡片

### 步骤4: 生成处理统计
- 统计总卡片数、已处理数、待处理数
- 计算处理率

## ⚙️ 配置要求

### 必需环境变量
```bash
# 行动库配置
ACTION_DATABASE_ID=18ce666e-cf2c-81e5-9d35-ff0e34839121

# 目标数据库配置
TARGET_DATABASE_ID=your_target_database_id_here
```

### 可选环境变量（邮件服务）
```bash
# 邮件服务配置
EMAIL_SERVICE=gmail
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_app_password_here
EMAIL_TO=your_email@gmail.com
```

## 📋 行动库任务结构

### 任务属性
- **标题**: 自动生成的格式 `卡片处理需求-YYYYMMDDHHMM`
- **状态**: 待处理
- **优先级**: 中
- **类型**: 卡片处理
- **创建时间**: 自动设置

### 任务内容
1. **概述**: 说明任务目的和卡片数量
2. **待处理卡片列表**: 每个卡片的详细信息
   - 卡片标题
   - 讨论ID
   - 来源笔记ID
   - 卡片链接（如果有）
3. **处理要求**: 具体的操作步骤
4. **创建时间**: 任务创建时间

## 📧 邮件通知格式

### 邮件主题
`卡片处理需求-YYYYMMDDHHMM`

### 邮件内容
- 📋 概述：待处理卡片数量
- 🔗 行动任务：行动库任务链接
- 📝 待处理卡片列表：每个卡片的详细信息
- ⚠️ 处理要求：具体的操作步骤
- 📅 生成时间：邮件生成时间

## 🧪 测试方法

### 1. 检查配置
```bash
node test-workflow.js
```

### 2. 手动执行工作流
```bash
# 在 main.js 中已经集成，每次同步后自动执行
node src/main.js
```

## 🔄 集成到主流程

工作流已经集成到主同步流程中，作为第8步自动执行：

1. 验证目标数据库结构
2. 获取数据库统计信息
3. 获取未执行笔记
4. 获取有效讨论
5. 处理讨论内容
6. 写入数据库
7. 更新自动化状态
8. **执行卡片处理工作流** ← 新增
9. 获取最终统计信息

## 📊 监控和统计

### 工作流状态
- 配置完整性检查
- 执行状态监控
- 错误处理和日志

### 卡片处理统计
- 总卡片数
- 已处理卡片数
- 待处理卡片数
- 处理率百分比

## 🚨 注意事项

1. **行动库权限**: 确保Notion集成有权限在行动库中创建页面
2. **邮件服务**: 如果不需要邮件通知，可以不配置邮件相关环境变量
3. **数据库字段**: 确保目标数据库包含必要的字段：
   - `DiscussionID` (Rich Text)
   - `它在解决什么问题？` (Rich Text)
   - `创建时间` (Date)
4. **性能考虑**: 工作流会在每次同步后执行，确保数据库查询性能

## 🔧 故障排除

### 常见问题
1. **配置不完整**: 检查环境变量是否完整
2. **权限不足**: 确认Notion集成权限
3. **字段缺失**: 验证数据库结构
4. **邮件发送失败**: 检查邮件服务配置

### 调试方法
1. 查看日志输出
2. 检查工作流配置状态
3. 验证数据库查询结果
4. 测试邮件服务连接

## 📈 未来扩展

- 支持多种邮件服务
- 添加Slack/Teams通知
- 支持自定义任务模板
- 添加处理进度跟踪
- 支持批量操作
